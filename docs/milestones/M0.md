# Milestone 0: Development Environment Setup

**Status:** Complete
**Ref:** `docs/PROJECT.md` Section 7, Milestone 0

## Objective

Set up the complete development environment so that all subsequent milestones can begin without tooling interruptions. After M0, the project has a working Python environment, verified dependencies, a complete directory scaffold, and passing verification scripts.

## Dependencies

- macOS with Python 3.10+ installed
- Webcam (built-in or USB)
- Git initialized (already done)
- ESP32 DevKit C + USB cable (for ESP32 tasks only — can be deferred)

## Out of Scope

- Writing any application source code (`src/*.py` module implementations)
- URDF model creation (M1)
- Pose estimation pipeline (M2)
- ESP32 firmware beyond blink LED (M3)
- Any ROS2 setup (Phase B)

---

## Deliverables

| # | Artifact | Path | Description |
|---|----------|------|-------------|
| D1 | Python virtual environment | `venv/` | Python 3.10+ venv at repo root |
| D2 | Requirements file | `requirements.txt` | Pinned dependency versions |
| D3 | Directory scaffold | (see spec below) | All planned directories created |
| D4 | Gitignore | `.gitignore` | Python, macOS, ESP32, IDE ignores |
| D5 | Source module stubs | `src/*.py` | Empty `__init__.py` + placeholder files so imports work |
| D6 | Config file | `config/settings.yaml` | Default config with all sections |
| D7 | Camera verification script | `tests/test_camera.py` | Opens webcam, displays frame, exits on 'q' |
| D8 | PyBullet verification script | `tests/test_pybullet.py` | Loads sample URDF, runs 5s simulation |
| D9 | MediaPipe verification script | `tests/test_pose.py` | Runs pose estimation on webcam feed |
| D10 | Pytest config | `pytest.ini` | Test discovery configuration |
| D11 | Setup script | `scripts/setup.sh` | One-command environment bootstrap |

---

## Technical Spec

### S1: Directory Structure

Create the following directories (empty dirs get a `.gitkeep`):

```
real_steel/
├── .gitignore
├── CLAUDE.md                          # (exists)
├── requirements.txt
├── pytest.ini
├── docs/
│   ├── PROJECT.md                     # (exists)
│   └── milestones/                    # (exists)
├── src/
│   ├── __init__.py
│   ├── camera.py                      # stub
│   ├── pose_estimator.py              # stub
│   ├── angle_calculator.py            # stub
│   ├── motion_mapper.py               # stub
│   ├── robot_interface.py             # stub
│   ├── simulated_robot.py             # stub
│   ├── real_robot.py                  # stub
│   ├── visualizer.py                  # stub
│   └── main.py                        # stub
├── tests/
│   ├── __init__.py
│   ├── test_camera.py
│   ├── test_pybullet.py
│   └── test_pose.py
├── config/
│   └── settings.yaml
├── urdf/
│   └── .gitkeep
├── esp32/
│   ├── real_steel_controller/
│   │   └── .gitkeep
│   └── test_sketches/
│       └── .gitkeep
├── hardware/
│   └── .gitkeep
├── data/
│   ├── calibration/
│   │   └── .gitkeep
│   └── recordings/
│       └── .gitkeep
└── scripts/
    └── setup.sh
```

### S2: `.gitignore`

```gitignore
# Python
venv/
__pycache__/
*.pyc
*.pyo
*.egg-info/
dist/
build/
.eggs/

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# macOS
.DS_Store

# Data
data/recordings/*.mp4
data/recordings/*.avi
data/calibration/*.json

# ESP32
esp32/**/build/
esp32/**/.pio/

# Secrets / local overrides
.env
*.local.yaml
```

### S3: `requirements.txt`

```
opencv-python>=4.8.0
mediapipe>=0.10.0
numpy>=1.24.0
pyserial>=3.5
pybullet>=3.2.5
pyyaml>=6.0
matplotlib>=3.7.0
pytest>=7.0.0
```

### S4: `config/settings.yaml`

```yaml
camera:
  device_id: 0
  width: 640
  height: 480
  fps: 30

pose:
  min_detection_confidence: 0.5
  min_tracking_confidence: 0.5

angles:
  smoothing_factor: 0.3

mapping:
  mirror_mode: true
  dead_zone_deg: 3.0

serial:
  port: /dev/tty.usbserial-0001
  baud: 115200

simulation:
  urdf_path: urdf/real_steel.urdf

safety:
  max_velocity: 2.0
  position_tolerance: 0.1
  watchdog_timeout: 2.0
  max_continuous_runtime: 600
```

### S5: Source Module Stubs

Each file in `src/` gets a minimal stub — just a docstring stating the module's purpose. No implementation. Example:

```python
"""Camera input module. Captures frames from webcam via OpenCV."""
```

This ensures the package is importable and `__init__.py` can exist without errors.

### S6: Verification Scripts

These are standalone scripts (not pytest unit tests) that verify the environment works. They should be runnable directly with `python tests/test_<name>.py` and also callable via pytest (each should contain a skippable test function for CI environments without hardware).

#### `tests/test_camera.py`

- Open `cv2.VideoCapture(0)`
- Assert `cap.isOpened()` is True
- Read one frame, assert `ret` is True and frame shape is `(480, 640, 3)`
- Display in window titled "Camera Test" in a loop
- Exit on 'q' keypress
- Release capture and destroy windows
- Include a pytest function `test_camera_opens()` that just verifies the camera can be opened and one frame read (no GUI loop)

#### `tests/test_pybullet.py`

- Connect to PyBullet in `GUI` mode
- Set additional search path to `pybullet_data.getDataPath()`
- Set gravity `(0, 0, -9.8)`
- Load `kuka_iiwa/model.urdf`
- Print joint count
- Step simulation for 5 seconds (240 steps/sec × 5)
- Disconnect
- Include a pytest function `test_pybullet_loads()` that connects in `DIRECT` mode (headless), loads the URDF, asserts joint count > 0, disconnects

#### `tests/test_pose.py`

- Import `mediapipe` and `cv2`
- Open webcam
- Initialize `mp.solutions.pose.Pose()`
- Process frames in a loop, draw landmarks with `mp.solutions.drawing_utils`
- Display in window titled "Pose Test"
- Exit on 'q' keypress
- Include a pytest function `test_mediapipe_imports()` that verifies mediapipe and its pose solution can be imported and instantiated

### S7: `pytest.ini`

```ini
[pytest]
testpaths = tests
python_files = test_*.py
python_functions = test_*
```

### S8: `scripts/setup.sh`

```bash
#!/bin/bash
set -e

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$REPO_ROOT"

echo "Creating Python virtual environment..."
python3 -m venv venv
source venv/bin/activate

echo "Installing dependencies..."
pip install --upgrade pip
pip install -r requirements.txt

echo "Verifying imports..."
python -c "import cv2; print(f'OpenCV {cv2.__version__}')"
python -c "import mediapipe; print(f'MediaPipe {mediapipe.__version__}')"
python -c "import numpy; print(f'NumPy {numpy.__version__}')"
python -c "import pybullet; print(f'PyBullet {pybullet.__version__}')"
python -c "import serial; print(f'pyserial {serial.__version__}')"
python -c "import yaml; print(f'PyYAML {yaml.__version__}')"

echo ""
echo "Setup complete. Activate with: source venv/bin/activate"
```

---

## Tasks

### Task 0.1: Create directory scaffold

Create all directories listed in S1. Add `.gitkeep` to empty directories.

**Produces:** All directories in the tree
**Done when:** `find . -type d` matches the planned layout

### Task 0.2: Create `.gitignore`

Write `.gitignore` as specified in S2.

**Produces:** `.gitignore`
**Done when:** File exists with all listed patterns

### Task 0.3: Create `requirements.txt`

Write requirements as specified in S3. Include `pytest`.

**Produces:** `requirements.txt`
**Done when:** File exists with all dependencies listed

### Task 0.4: Create `scripts/setup.sh`

Write the bootstrap script as specified in S8. Make it executable.

**Produces:** `scripts/setup.sh`
**Done when:** `bash scripts/setup.sh` creates venv and installs all deps without error

### Task 0.5: Run `scripts/setup.sh`

Execute the setup script. Verify all imports succeed.

**Requires:** Task 0.3, Task 0.4
**Done when:** All import verification lines print version numbers without error

### Task 0.6: Create `config/settings.yaml`

Write the default config as specified in S4.

**Produces:** `config/settings.yaml`
**Done when:** `python -c "import yaml; yaml.safe_load(open('config/settings.yaml'))"` succeeds

### Task 0.7: Create source module stubs

Create `src/__init__.py` and all stub modules listed in S5.

**Produces:** `src/__init__.py`, `src/camera.py`, etc.
**Done when:** `python -c "from src import camera"` succeeds

### Task 0.8: Create `pytest.ini`

Write pytest configuration as specified in S7.

**Produces:** `pytest.ini`
**Done when:** `python -m pytest --collect-only` runs without config errors

### Task 0.9: Create verification script — Camera

Write `tests/test_camera.py` as specified in S6.

**Requires:** Task 0.5
**Produces:** `tests/test_camera.py`
**Done when:** `python tests/test_camera.py` opens webcam window; `pytest tests/test_camera.py::test_camera_opens` passes

### Task 0.10: Create verification script — PyBullet

Write `tests/test_pybullet.py` as specified in S6.

**Requires:** Task 0.5
**Produces:** `tests/test_pybullet.py`
**Done when:** `python tests/test_pybullet.py` opens PyBullet GUI with Kuka arm; `pytest tests/test_pybullet.py::test_pybullet_loads` passes

### Task 0.11: Create verification script — MediaPipe Pose

Write `tests/test_pose.py` as specified in S6.

**Requires:** Task 0.5
**Produces:** `tests/test_pose.py`
**Done when:** `python tests/test_pose.py` shows pose landmarks on webcam feed; `pytest tests/test_pose.py::test_mediapipe_imports` passes

### Task 0.12: Run all pytest checks (headless)

Run `pytest tests/` to verify all headless test functions pass.

**Requires:** Tasks 0.8–0.11
**Done when:** `pytest` exits with 0 failures on the headless test functions

---

## Acceptance Criteria

- [x] `source venv/bin/activate && python -c "import cv2, mediapipe, numpy, pybullet, serial, yaml"` succeeds
- [ ] `python tests/test_camera.py` opens webcam and displays frames (requires manual verification)
- [ ] `python tests/test_pybullet.py` opens PyBullet GUI with a robot (requires manual verification)
- [ ] `python tests/test_pose.py` shows pose landmarks overlaid on webcam feed (requires manual verification)
- [x] `pytest tests/` passes all headless test functions (pybullet + mediapipe)
- [x] All planned directories exist
- [x] `config/settings.yaml` is valid YAML with all config sections
- [x] `.gitignore` covers Python, macOS, IDE, ESP32, and data artifacts

## Notes

### MediaPipe API Change

The PRD references `mp.solutions.pose.Pose()` (legacy solutions API). This API no longer exists in MediaPipe >= 0.10.30 on macOS ARM. The project uses the new tasks API instead:

```python
from mediapipe.tasks.python import BaseOptions, vision

options = vision.PoseLandmarkerOptions(
    base_options=BaseOptions(model_asset_path="data/pose_landmarker_lite.task"),
    num_poses=1,
)
landmarker = vision.PoseLandmarker.create_from_options(options)
result = landmarker.detect(mp_image)  # result.pose_landmarks
```

This requires a downloaded model file at `data/pose_landmarker_lite.task` (downloaded by `scripts/setup.sh`). Future milestones (especially M2: Perception Pipeline) must use this API, not the PRD's `mp.solutions` examples.
